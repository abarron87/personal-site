CategoryMapBuilder={getPreviousSibling:function(a){var b=a.previousSibling;return 1!==b.nodeType?this.getPreviousSibling(b):b},buildCategoriesMap:function(a){for(var b=document.getElementById(a.root),c=b.children,d=a.categoriesMap||{},e=a.count||0,f=a.containerIdentifier||"_container",g=a.currentPath||"/"+this.getPreviousSibling(b).getElementsByTagName("a")[0].innerHTML,h=0,i=c.length;i>h;h++){var j=c[h],k=j.getAttribute("id");if("div"===j.tagName.toLowerCase()&&k&&~k.indexOf(f)){var l=this.getPreviousSibling(j),m=l.getElementsByTagName("a")[0].innerHTML,n=k.match(/category_(\d+)/)[1],o=j.parentNode.getAttribute("id").match(/category_(\d+)/)[1];e++,d[n]={parentId:o,name:m,path:g},d=this.buildCategoriesMap({root:k,categoriesMap:d,count:e,currentPath:g+"/"+m})}}return d}};var TreeCategoriesAutoSuggest={Models:{},Views:{},Collections:{}};TreeCategoriesAutoSuggest.Collections.Suggestions=TreeCategoriesAutoSuggest.Collections.SelectedCategories=Backbone.Collection.extend({model:TreeCategoriesAutoSuggest.Models.Category}),TreeCategoriesAutoSuggest.Models.Category=Backbone.Model.extend({defaults:{id:"",name:"",path:"",parentId:""}}),Array.prototype.indexOfCategory=function(a){for(var b=0,c=this.length;c>b;b++)if(this[b].id===a)return b;return-1},TreeCategoriesAutoSuggest.Views.App=Backbone.View.extend({id:"superheroesAutoSuggestContainer",className:"suggestionsContainer",events:{"keyup .text":"handleQuery"},initialize:function(){this.startState=!0,this.categoriesMap=CategoryMapBuilder.buildCategoriesMap({root:"category_1_container"}),this.selectedCategories=[],this.suggestions=[],this.subViews={},Backbone.Mediator.subscribe("SuggestionSelected",this.addSelectionAndParents,this),Backbone.Mediator.subscribe("SelectionRemoved",this.removeSelections,this),console.log(jQuery("#autoSuggestTemplate").text().replace(/(\s|\t)+/,"")),this.template=_.template(jQuery("#autoSuggestTemplate").html()),jQuery.isEmptyObject(this.categoriesMap)||this.render(),console.log(this.categoriesMap)},render:function(){jQuery("#superheroesWrapper").append(this.$el.html(this.template()))},renderSuggestions:function(){var a=this.$el.find(".taxonomySuggestions"),b=this.subViews.suggestions;b.render(),b.collection.length?a.removeClass("hide"):a.addClass("hide")},renderSelectedCategories:function(){var a=this.$el.find(".selectedCategories"),b=this.subViews.selectedCategories;b.render(),b.collection.length?a.removeClass("hide"):a.addClass("hide")},handleQuery:function(a){var b=jQuery(a.target||a.srcElement).val();this.suggestions=this.getSuggestions(b),this.setSuggestions(),this.renderSuggestions()},getSuggestions:function(a){this.query=a;var b=[];if(this.query.length>2)for(var c in this.categoriesMap)if(this.categoriesMap.hasOwnProperty(c)){var d=this.categoriesMap[c],e=d.name;~e.toLowerCase().indexOf(this.query.toLowerCase())&&!~this.selectedCategories.indexOfCategory(c)&&b.push(new TreeCategoriesAutoSuggest.Models.Category({id:c,name:e,parentId:d.parentId,path:d.path}))}return b},setSuggestions:function(){this.startState?(this.subViews.suggestions=new TreeCategoriesAutoSuggest.Views.Suggestions({collection:new TreeCategoriesAutoSuggest.Collections.Suggestions(this.suggestions)}),this.startState=!1):this.subViews.suggestions.collection.reset(this.suggestions)},addSelectionAndParents:function(a){var b=this.categoriesMap[a],c=[a];c=this.getParentCategories(b,c);for(var d=c.length-1;d>=0;d--)this.selectedCategories=this.addSelection(c[d]);this.suggestions=this.getSuggestions(this.query),this.setSuggestions(),this.renderSuggestions(),this.setSelectedCategories(),this.renderSelectedCategories(),console.log(this.selectedCategories)},getParentCategories:function(a,b){return this.categoriesMap.hasOwnProperty(a.parentId)&&(b.push(a.parentId),b=this.getParentCategories(this.categoriesMap[a.parentId],b)),b},addSelection:function(a){var b=this.categoriesMap[a];return b&&!~this.selectedCategories.indexOfCategory(a)&&this.selectedCategories.push({id:a,parentId:b.parentId,name:b.name,path:b.path}),this.selectedCategories},removeSelections:function(a){this.removeSelection(a.categoryId);for(var b in a.childrenMap)a.childrenMap.hasOwnProperty(b)&&this.removeSelection(b);this.setSelectedCategories(),this.suggestions=this.getSuggestions(this.query),this.setSuggestions(),this.renderSelectedCategories(),this.renderSuggestions()},removeSelection:function(a){var b=this.selectedCategories.indexOfCategory(a);~b?this.selectedCategories.splice(b,1):console.log("Category not present")},setSelectedCategories:function(){this.subViews.hasOwnProperty("selectedCategories")?this.subViews.selectedCategories.collection.reset(this.selectedCategories):this.subViews.selectedCategories=new TreeCategoriesAutoSuggest.Views.SelectedCategories({collection:new TreeCategoriesAutoSuggest.Collections.SelectedCategories(this.selectedCategories)})}}),TreeCategoriesAutoSuggest.Views.Suggestion=Backbone.View.extend({model:TreeCategoriesAutoSuggest.Models.Category,tagName:"li",events:{"change .checkbox":"handleCheckboxClick"},initialize:function(){this.template=_.template(jQuery("#suggestionTemplate").html()),this.render()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},handleCheckboxClick:function(a){var b=jQuery(a.target||a.srcElement).attr("id");Backbone.Mediator.publish("SuggestionSelected",b)}}),TreeCategoriesAutoSuggest.Views.SelectedCategory=Backbone.View.extend({model:TreeCategoriesAutoSuggest.Models.Category,tagName:"li",id:"selectedCategory_<%= id %>",events:{"click .remove":"handleRemoveClick"},initialize:function(){this.template=_.template(jQuery("#selectedCategoryTemplate").html()),this.render()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},handleRemoveClick:function(a){var b=jQuery(a.target||a.srcElement).attr("id").match(/selectedCategory_(\d+)/)[1],c=CategoryMapBuilder.buildCategoriesMap({root:"category_"+b+"_container"});Backbone.Mediator.publish("SelectionRemoved",{childrenMap:c,categoryId:b})}}),Backbone.CollectionView=Backbone.View.extend({subViews:[],subViewType:Backbone.View,handleReset:function(){console.log("reset"),this.cleanupOldSubViews(),this.initSubViews()},initSubViews:function(){this.collection.each(function(a){this.subViews.push(new this.subViewType({model:a}))},this)},cleanupOldSubViews:function(){_.each(this.subViews,function(a){a.remove()},this),this.subViews=[]}}),TreeCategoriesAutoSuggest.Views.Suggestions=Backbone.CollectionView.extend({el:".taxonomySuggestions ul",subViewType:TreeCategoriesAutoSuggest.Views.Suggestion,initialize:function(){this.collection.on("reset",this.handleReset,this),this.suggestionViews=[],this.initSubViews()},render:function(){_.each(this.subViews,function(a){this.$el.append(a.render().el)},this)}}),TreeCategoriesAutoSuggest.Views.SelectedCategories=Backbone.CollectionView.extend({el:".selectedCategories ul",subViewType:TreeCategoriesAutoSuggest.Views.SelectedCategory,initialize:function(){this.collection.on("reset",this.handleReset,this),this.selectedCategoryViews=[],this.initSubViews()},render:function(){_.each(this.subViews,function(a){this.$el.append(a.render().el)},this)}});